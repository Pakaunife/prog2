<div class="admin-container">
  <aside class="admin-sidebar">
    <h3>Admin</h3>
    <ul>
      <li class="active">
        <span>ðŸ‘¤</span> Gestione Utenti
      </li>
    </ul>
  </aside>

  <main class="admin-main">
    <section class="admin-card">
      <h2>Gestione Utenti</h2>
      <div *ngIf="loading">Caricamento...</div>
      <div *ngIf="errore">{{ errore }}</div>
      <table *ngIf="!loading && utenti.length">
        <thead>
          <tr>
            <th>ID</th>
            <th>Email</th>
            <th>Ruolo</th>
            <th>Stato</th>
            <th>Ordini</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let utente of utenti">
            <tr>
              <td>{{ utente.id }}</td>
              <td>{{ utente.email }}</td>
              <td>{{ utente.ruolo }}</td>
              <td>{{ utente.is_blocked ? 'Bloccato' : 'Attivo' }}</td>
              <td>
                {{ ordiniPerUtente[utente.id]?.length || 0 }}
                <button (click)="toggleOrdini(utente.id)">
                  {{ utenteMostraOrdini === utente.id ? 'Nascondi' : 'Vedi ordini' }}
                </button>
              </td>
              <td>
                <button (click)="bloccaUtente(utente.id)" [disabled]="utente.is_blocked">Blocca</button>
                <button (click)="sbloccaUtente(utente.id)" *ngIf="utente.is_blocked">Sblocca</button>
                <button *ngIf="utente.ruolo !== 'admin'" (click)="gestisciAdmin(utente.id, true)">Rendi Admin</button>
                <button *ngIf="utente.ruolo === 'admin'" (click)="gestisciAdmin(utente.id, false)">Rimuovi Admin</button>
                <button class="danger" (click)="rimuoviUtente(utente.id)">Rimuovi</button>
              </td>
            </tr>
            <tr *ngIf="utenteMostraOrdini === utente.id">
              <td colspan="6">
                <table class="ordini-table" *ngIf="ordiniPerUtente[utente.id]?.length">
                  <thead>
                    <tr>
                      <th>ID Ordine</th>
                      <th>Data</th>
                      <th>Totale</th>
                      <th>Stato</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let ordine of ordiniPerUtente[utente.id]">
                        <td>{{ ordine.id }}</td>
                        <td>{{ ordine.data || ordine.created_at }}</td>
                        <td>{{ ordine.totale }}</td>
                        <td>{{ ordine.stato }}</td>
                        <td>
                            <button (click)="apriDettaglioOrdine(ordine)">Dettaglio</button>
                        </td>
                        </tr>
                  </tbody>
                </table>
                <div *ngIf="ordiniPerUtente[utente.id] && !ordiniPerUtente[utente.id].length">
                  Nessun ordine per questo utente.
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </section>
    <div class="modal-backdrop" *ngIf="ordineDettaglio" (click)="ordineDettaglio = null"></div>
<div class="modal" *ngIf="ordineDettaglio">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h4>Dettaglio Ordine #{{ ordineDettaglio.id }}</h4>
    <p>Data: {{ ordineDettaglio.data || ordineDettaglio.created_at }}</p>
    <p>Totale: {{ ordineDettaglio.totale }}</p>
    <p>Stato attuale: <b>{{ ordineDettaglio.stato }}</b></p>
    
    <label>Nuovo stato:
      <select [(ngModel)]="nuovoStatoOrdine">
        <option value="spedito">Spedito</option>
        <option value="in transito">In transito</option>
        <option value="consegnato">Consegnato</option>
        <option value="annullato">Annullato</option>
      </select>
    </label>
    <label>Dettagli spedizione:
  <textarea [(ngModel)]="dettagliSpedizione" [disabled]="ordineDettaglio.stato === 'annullato'" rows="2"></textarea>
</label>
    <div class="modal-actions">
      <button (click)="aggiornaStatoOrdine()" [disabled]="ordineDettaglio.stato === 'annullato'">Aggiorna stato</button>
      <button (click)="ordineDettaglio = null">Chiudi</button>
    </div>
    <div *ngIf="ordineDettaglio.stato === 'annullato'" style="color: #b00; margin-top: 1rem;">
  L'ordine Ã¨ annullato e non puÃ² piÃ¹ essere modificato.
</div>
  </div>
</div>
  </main>
</div>